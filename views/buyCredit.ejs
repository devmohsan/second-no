<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Second Number -Buy Credit</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    #card-element {
      padding: 12px;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      background: white;
    }

    .package-option {
      padding: 8px 12px;
    }

    .package-option:hover {
      background-color: #F3F4F6;
    }
  </style>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

  <div class="bg-white shadow-xl rounded-xl p-6 max-w-md w-full">
    <!-- Header -->
    <div class="text-center mb-6">
      <div class="text-green-500 text-4xl mb-3">
        <i class="fas fa-coins"></i>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">Purchase Credits</h1>
      <p class="text-gray-600 mt-1">Select a credit package and complete payment</p>
    </div>

    <!-- Package Selection -->
    <div class="mb-6 space-y-4">
      <% if (activerpackages && activerpackages.length > 0) { %>
      <div>
        <label for="packageDropdown" class="block text-sm font-medium text-gray-700 mb-1">Select Package</label>
        <select id="packageDropdown" class="w-full border border-gray-300 rounded-md p-2 focus:ring-green-500 focus:border-green-500">
          <option value="">-- Select a package --</option>
          <% activerpackages.forEach(pkg => { %>
          <option value="<%= pkg.id %>" data-name="<%= pkg.name %>" data-price="<%= pkg.price %>" data-credits="<%= pkg.credits %>" <%= (pkg.id == selectpackage) ? 'selected' : '' %>>
            <%= pkg.name %> - $<%= pkg.price %> (<%= pkg.credits %> credits)
          </option>
          <% }) %>
        </select>
      </div>

      <!-- Selected Package Details -->
      <div id="selectedPackageDetails" class="bg-gray-50 rounded-lg p-4 <%= selectpackage ? '' : 'hidden' %>">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-medium text-gray-800" id="selectedPackageName">
              <% if (selectpackage) { %>
              <%= activerpackages.find(p => p.id == selectpackage)?.name %>
              <% } %>
            </h3>
            <p class="text-sm text-gray-500" id="selectedPackageCredits">
              <% if (selectpackage) { %>
              <%= activerpackages.find(p => p.id == selectpackage)?.credits %> credits
              <% } %>
            </p>
          </div>
          <div class="text-right">
            <p class="font-bold text-green-600" id="selectedPackagePrice">
              <% if (selectpackage) { %>
              $<%= activerpackages.find(p => p.id == selectpackage)?.price %>
              <% } %>
            </p>
            <% if (selectpackage && activerpackages.find(p => p.id == selectpackage)?.discount) { %>
            <p class="text-xs text-green-500">
              Save <%= activerpackages.find(p => p.id == selectpackage)?.discount %>%
            </p>
            <% } %>
          </div>
        </div>
      </div>

      <input type="hidden" id="packageId" name="packageId" value="<%= selectpackage %>">
      <% } else { %>
      <div class="bg-yellow-50 border border-yellow-200 rounded p-4 text-center">
        <i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i>
        <span class="text-yellow-700">No active packages available at this time</span>
      </div>
      <% } %>
    </div>

    <!-- Payment Form -->
    <form id="payment-form" class="space-y-4">
      <input type="hidden" id="publishableKey" value="<%= publishableKey %>">
      <input type="hidden" name="user" value="<%= user %>">

      <!-- Card Details -->
      <div>
        <label class="block font-medium text-gray-700 mb-2">Payment Details</label>
        <div id="card-element" class="mb-1"></div>
        <div id="card-errors" class="text-red-500 text-sm"></div>
      </div>

      <button type="submit" id="submitBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition 
               <%= selectpackage ? '' : 'opacity-50 cursor-not-allowed' %>" <%= selectpackage ? '' : 'disabled' %>>
        <i class="fas fa-lock mr-2"></i>
        <% if (selectpackage) { %>
        Pay $<%= activerpackages.find(p => p.id == selectpackage)?.price %>
        <% } else { %>
        Select a Package
        <% } %>
      </button>
    </form>
  </div>

  <script>
    // Package Selection
    document.addEventListener("DOMContentLoaded", () => {
      const packageDropdown = document.getElementById('packageDropdown');
      const selectedPackageDetails = document.getElementById('selectedPackageDetails');
      const selectedPackageName = document.getElementById('selectedPackageName');
      const selectedPackagePrice = document.getElementById('selectedPackagePrice');
      const selectedPackageCredits = document.getElementById('selectedPackageCredits');
      const packageIdInput = document.getElementById('packageId');
      const submitBtn = document.getElementById('submitBtn');

      if (packageDropdown) {
        packageDropdown.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];

          if (selectedOption.value) {
            // Show package details
            selectedPackageDetails.classList.remove('hidden');
            selectedPackageName.textContent = selectedOption.dataset.name;
            selectedPackagePrice.textContent = '$' + selectedOption.dataset.price;
            selectedPackageCredits.textContent = selectedOption.dataset.credits + ' credits';

            // Update hidden field
            packageIdInput.value = selectedOption.value;

            // Update button
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            submitBtn.innerHTML = `<i class="fas fa-lock mr-2"></i> Pay $${selectedOption.dataset.price}`;
          } else {
            // Hide package details if "Select a package" is chosen
            selectedPackageDetails.classList.add('hidden');
            packageIdInput.value = '';

            // Disable button
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> Select a Package';
          }
        });
      }

      // Stripe Payment
      const stripe = Stripe(document.getElementById("publishableKey").value);
      const elements = stripe.elements();

      const card = elements.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#374151',
            '::placeholder': {
              color: '#9CA3AF',
            },
          },
          invalid: {
            color: '#EF4444',
          },
        },
        hidePostalCode: true
      });

      card.mount('#card-element');

      // Form submission
      const form = document.getElementById('payment-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const packageId = packageIdInput.value;
        if (!packageId) {
          alert('Please select a package first');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
        const {
          token,
        } = await stripe.createToken(card);

        // if (error) {
        //   throw error;
        // }

        const {
          paymentMethod,
          error
        } = await stripe.createPaymentMethod({
          type: 'card',
          card: card,
          billing_details: {
            name: 'Customer'
          }
        });

        if (error) {
          document.getElementById('card-errors').textContent = error.message;
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> Try Again';
        } else {
          try {
            const response = await fetch('/stripe/process-payment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                paymentMethodId: token.id,
                packageId: packageId,
                userId: form.querySelector('input[name="user"]').value
              })
            });

            const result = await response.json();

            if (!result.status) {
              document.getElementById('card-errors').textContent = result.error;
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> Try Again';
            } else {
              window.location.href = '/stripe/success';
            }
          } catch (err) {
            document.getElementById('card-errors').textContent = 'Payment failed. Please try again.';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-lock mr-2"></i> Try Again';
          }
        }
      });

      // Real-time validation
      card.addEventListener('change', (event) => {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });
    });
  </script>
</body>

</html>